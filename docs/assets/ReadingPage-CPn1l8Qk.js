import{e as Ie,s as _e,a5 as xe,q as Se,r as m,d as j,x as Ee,k as X,l as o,u as t,W as C,X as y,Y as E,f as Y,m as n,M as Z,y as A,B as K,C as u,z as k,G as w,am as ke,T as Q,ao as Pe,ae as ee,af as Te,a3 as B,D as te,ap as De,O as be,P as Re,a1 as P,aq as Ue,J as Me,a6 as Ae,ar as Be,as as Le,at as Oe,au as Ne,E as ae,av as ne,aw as Ve,ax as Ge,U as Fe,ay as se,V as oe,a7 as qe,a8 as He,$ as $e,a0 as ze,Z as Je,_ as We}from"./index-CIdF5UML.js";import{C as je}from"./Crypto-BacUgYB-.js";import{C as Xe}from"./ChaptersView-CmsChPs7.js";var d;(f=>{f.timestamp=new Date().getTime(),f.urlManga=""})(d||(d={}));const Ye=f=>($e("data-v-9ad4d43b"),f=f(),ze(),f),Ze={class:"spinner-container"},Ke=Ye(()=>P("div",{class:"image-container"},null,-1)),le=25*1e3,L=15,Qe=Ie({__name:"ReadingPage",setup(f){var J,W;const re=_e(),O=xe(),g=Se(),l=m(),N=m(""),ie=m(),I=j(()=>{var a;return g.getters["histories/getHistory"](((a=l.value)==null?void 0:a.url)||"")}),p=j(()=>g.getters["account/getAccount"]);let h=m(L);const T=m(!1),D=m(!1),_=m(!1);var b;function ce(a){const e=document.querySelector(".image-container");var s=document.createElement("img");s.classList.add("img-chapter"),s.src=a,e.appendChild(s)}async function R(a){try{(await C.post(y.CHAPTER_DETAIL,{url:a},{headers:{app:E}})).data.data.images.forEach((r,i)=>{let c=i>4?5:i+1;setTimeout(()=>{_.value=!1,ce(r)},c*2e3)})}catch(e){console.log("Chapter detail error: ",e)}}function V(a){_.value=!0;const e=new Date().getTime();if(console.log(p.value.licenses),e-d.timestamp>=le&&M()&&(q(),U()),l.value){l.value.currentChapter=a;const s=l.value.chapters.find(c=>{var v;return c._id===((v=l.value)==null?void 0:v.currentChapter)}),r=document.querySelector(".content-reading");r&&r.scrollToTop(0),ie.value=[];const i=document.querySelector(".image-container");for(;i.firstChild;)i.removeChild(i.firstChild);de(),setTimeout(()=>{R((s==null?void 0:s.url)||"")},200)}}async function G(a){if(l.value){let e=l.value.currentChapter;a?e+=1:e-=1,e>=1&&e<=l.value.chapters.length&&V(e)}}function ue(a){setTimeout(async()=>{var s,r;const e=(s=l.value)==null?void 0:s.chapters.find(i=>{var c;return i._id===((c=l.value)==null?void 0:c.currentChapter)});await R((e==null?void 0:e.url)||""),(r=a.target)==null||r.complete()},1e3)}function de(){g.dispatch("histories/setHistory",l.value)}async function pe(){await se.open("end")}async function F(){await se.close("end")}function fe(a){V(a),F()}function q(){let a=L;const e=setInterval(()=>{a--,h.value=a,a===0&&clearInterval(e)},1e3)}function H(){D.value=!0,T.value=!1,h.value=L}function $(){H(),localStorage.setItem("isShowPopupUpgrade","false"),d.timestamp=new Date().getTime()}function U(){D.value=!1,T.value=!0}function me(){h.value!==0?localStorage.setItem("isShowPopupUpgrade","true"):(localStorage.setItem("isShowPopupUpgrade","false"),d.timestamp=new Date().getTime()),p.value.apikey?(H(),O.push("/payment")):ge()}async function ge(){await(await oe.create({header:"Please enter your email",buttons:[{text:"Cancel",role:"cancel"},{text:"Get code",role:"confirm",handler:ve}],inputs:[{placeholder:"Email",id:"email-input",value:""}],backdropDismiss:!1})).present()}async function he(a){await(await oe.create({header:a,buttons:[{text:"Cancel",role:"cancel"},{text:"Verify email",role:"confirm",handler:Ce}],inputs:[{placeholder:"OTP Code",id:"otp-code-input",value:""}],backdropDismiss:!1})).present()}async function ve(){try{await z();const e=document.getElementById("email-input").value;if(console.log("Email:",e),e){N.value=e;const r=(await C.post(y.GET_OTP_CODE,{email:e},{headers:{app:E}})).data;console.log("Get otp data: ",r.data),he(r.data.msg)}else x("Email is null or empty");S()}catch(a){console.error("Error:",a),x("An error occurred. Please try again later!"),S()}}async function Ce(){try{const e=document.getElementById("otp-code-input").value;if(await z(),e){const r=(await C.post(y.CONFIRM_LOGIN,{email:N.value,code:e},{headers:{app:E}})).data;g.dispatch("account/setAccount",r.data);const i=r.data.apikey,v=(await C.get(y.USER_INFO,{headers:{apikey:i}})).data;v.data.licenses.length>0&&(p.value.licenses=v.data.licenses,g.dispatch("account/setAccount",p.value),$()),ye(i)}else x("OTP code is null or empty");S()}catch(a){console.error("Error:",a),x("An error occurred. Please try again later!"),S()}}async function x(a){await(await qe.create({message:a,duration:1500,position:"bottom"})).present()}async function ye(a){try{const s=(await C.get(y.FAVORITES,{headers:{apikey:a}})).data;g.dispatch("favorites/setFavorites",s.data.map(r=>new Je(r.url,r.title,r.thumbnail,new Date(r.created_at),r._id)))}catch(e){console.log("Get favorites failed",e)}}async function z(){b=await He.create({duration:0}),b.present()}async function S(){b.dismiss()}function M(){return!!(!p.value.licenses||p.value.licenses&&p.value.licenses.length===0||we())}function we(){const a=new Date;return!!p.value.licenses.find(s=>new Date(s.expired_at)<a&&s.app===E)}return l.value=JSON.parse(je.decrypt(re.query.content)),d.urlManga!==((J=l.value)==null?void 0:J.url)&&(d.timestamp=new Date().getTime(),d.urlManga=((W=l.value)==null?void 0:W.url)||""),new Date().getTime()-d.timestamp>=le&&M()&&(q(),U()),Ee(async()=>{var s;I&&l.value&&l.value.currentChapter!==I.value.currentChapter&&(l.value.currentChapter=I.value.currentChapter,l.value.recentlyRead=I.value.recentlyRead);const a=(s=l.value)==null?void 0:s.chapters.find(r=>{var i;return r._id===((i=l.value)==null?void 0:i.currentChapter)});_.value=!0,await R((a==null?void 0:a.url)||""),(localStorage.getItem("isShowPopupUpgrade")||"false")=="true"&&M()&&U()}),(a,e)=>(Y(),X(t(Fe),{class:"can-go-back",id:"main-content",style:{"z-index":"2000"}},{default:o(()=>[n(t(Pe),{side:"end","content-id":"main-content",swipeGesture:!1},{default:o(()=>[n(t(Z),null,{default:o(()=>[n(t(A),null,{default:o(()=>[n(t(K),null,{default:o(()=>[u("Chapters")]),_:1}),n(t(k),{slot:"end"},{default:o(()=>[n(t(w),{icon:t(ke),onClick:F,style:{width:"24px",height:"24px"}},null,8,["icon"])]),_:1})]),_:1})]),_:1}),n(t(Q),{class:"ion-padding"},{default:o(()=>[n(Xe,{content:l.value,callback:fe},null,8,["content"])]),_:1})]),_:1}),n(t(Z),{translucent:!0},{default:o(()=>[n(t(A),null,{default:o(()=>[n(t(k),{slot:"start",onClick:e[0]||(e[0]=()=>t(O).back())},{default:o(()=>[n(t(w),{ios:t(ee),md:t(Te),style:{width:"24px",height:"24px","margin-left":"4px"},color:"primary"},null,8,["ios","md"]),n(t(B),{style:{"margin-left":"4px","font-size":"medium"},color:"primary"},{default:o(()=>[u("Back")]),_:1})]),_:1}),n(t(K),{class:"title-header",style:{"text-align":"center"}},{default:o(()=>{var s;return[u("Chapter "+te((s=l.value)==null?void 0:s.currentChapter),1)]}),_:1}),n(t(k),{slot:"end",onClick:e[1]||(e[1]=s=>pe())},{default:o(()=>[n(t(w),{icon:t(De),style:{width:"24px",height:"24px"}},null,8,["icon"])]),_:1})]),_:1})]),_:1}),n(t(Q),{fullscreen:!0,class:"content-reading"},{default:o(()=>[n(t(be),{slot:"fixed","pull-factor":.5,"pull-min":100,"pull-max":200,onIonRefresh:e[2]||(e[2]=s=>ue(s))},{default:o(()=>[n(t(Re))]),_:1}),P("div",Ze,[_.value?(Y(),X(t(Ue),{key:0})):Me("",!0)]),Ke,n(t(Ae),{id:"ads-modal","is-open":T.value,"can-dismiss":D.value},{default:o(()=>[n(t(Be),null,{default:o(()=>[n(t(Le),null,{default:o(()=>[n(t(Oe),null,{default:o(()=>[u("Upgrade to Premium")]),_:1})]),_:1}),n(t(Ne),null,{default:o(()=>[u(" Please upgrade to Premium to remove ads ")]),_:1}),n(t(k),{style:{margin:"0 18px 18px 12px","justify-content":"flex-end"}},{default:o(()=>[n(t(ae),{onClick:me,style:{"margin-right":"18px"}},{default:o(()=>[u("Upgrade Now")]),_:1}),n(t(ae),{onClick:$,disabled:t(h)>0},{default:o(()=>[u("Close "+te(t(h)>0?"(".concat(t(h),")"):""),1)]),_:1},8,["disabled"])]),_:1})]),_:1})]),_:1},8,["is-open","can-dismiss"])]),_:1}),n(t(Ge),null,{default:o(()=>[n(t(A),null,{default:o(()=>{var s,r,i;return[P("div",{slot:"start",class:ne(["navigate-chapter",{disabled:((s=l.value)==null?void 0:s.currentChapter)===1}]),onClick:e[3]||(e[3]=c=>G(!1))},[n(t(w),{icon:t(ee)},null,8,["icon"]),n(t(B),null,{default:o(()=>[u("Previous")]),_:1})],2),P("div",{slot:"end",class:ne(["navigate-chapter",{disabled:((r=l.value)==null?void 0:r.currentChapter)===((i=l.value)==null?void 0:i.chapters.length)}]),onClick:e[4]||(e[4]=c=>G(!0))},[n(t(B),null,{default:o(()=>[u("Next")]),_:1}),n(t(w),{icon:t(Ve)},null,8,["icon"])],2)]}),_:1})]),_:1})]),_:1}))}}),st=We(Qe,[["__scopeId","data-v-9ad4d43b"]]);export{st as default};
